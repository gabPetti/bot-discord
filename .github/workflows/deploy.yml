name: Push-to-EC2
on:
  push:
    branches:
      - main
jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the files
        uses: actions/checkout@v3

      - name: Copy files with SSH 
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{secrets.EC2_SSH_KEY}}
          ARGS: "-rltgoDzvO --delete"
          SOURCE: "./"
          REMOTE_HOST: "ec2-13-58-11-235.us-east-2.compute.amazonaws.com"
          REMOTE_USER: "ec2-user"
          TARGET: "/home/ec2-user"
          EXCLUDE: "/dist/, /node_modules/, **.env, env, watcher.sh"

      - name: Restart application
        env:
          REMOTE_HOST: "ec2-13-58-11-235.us-east-2.compute.amazonaws.com" # Replace with your EC2 IP
          REMOTE_USER: "ec2-user" # Replace with the correct EC2 user
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # Create SSH key file
          echo "$EC2_SSH_KEY" > private_key.pem
          chmod 600 private_key.pem

          # Connect to EC2 and restart PM2
          ssh -o StrictHostKeyChecking=no -i private_key.pem $REMOTE_USER@$REMOTE_HOST << 'EOF'
            cd bot-discord  # Change this to your project folder
            pip install -r requirements.txt
            pm2 restart 0 # Restart all PM2 processes
            pm2 save  # Save the process list
            exit
          EOF
        
          # Clean up SSH key
          rm -f private_key.pem

